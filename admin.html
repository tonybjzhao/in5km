<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>in5KM Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      margin: 32px;
      background: #fafafa;
    }
    h1 { margin-bottom: 4px; }
    h2 { margin-top: 32px; }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-top: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }
    button {
      padding: 8px 14px;
      margin-right: 8px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    button.danger {
      background: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button.warning {
      background: #f0ad4e;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button.secondary {
      background: #eee;
      border: none;
      border-radius: 4px;
    }
    button.primary {
      background: #5bc0de;
      color: white;
      border: none;
      border-radius: 4px;
    }
    input {
      padding: 6px;
      margin-right: 6px;
      min-width: 120px;
    }
    .warn {
      color: #b00;
      font-weight: 600;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .stat-box {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #5bc0de;
    }
    .stat-box.ended {
      border-left-color: #f0ad4e;
    }
    .stat-box.archived {
      border-left-color: #d9534f;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 600;
      margin-top: 4px;
    }
    pre {
      background: #0b1020;
      color: #e6edf3;
      padding: 12px;
      border-radius: 6px;
      max-height: 400px;
      overflow: auto;
      font-size: 13px;
    }
    .section-divider {
      margin: 24px 0;
      border-top: 2px solid #e0e0e0;
    }
  </style>
</head>
<body>

<h1>in5KM Admin</h1>
<p class="warn">
  This page is public on GitHub Pages.  
  Security must be enforced via Firebase Auth + DB Rules.
</p>

<div class="card">
  <h2>üîê Auth</h2>
  <button onclick="loginWithGithub()" class="primary">Login with GitHub</button>
  <button onclick="logout()" class="secondary">Logout</button>
  <span id="authStatus">Signed out</span>
</div>

<div class="card">
  <h2>üìä Database Statistics</h2>
  <button onclick="loadStats()" class="primary">Refresh Stats</button>
  <div class="stats" id="statsContainer">
    <div class="stat-box">
      <div class="stat-label">Total Posts</div>
      <div class="stat-value" id="statTotal">-</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Active Posts</div>
      <div class="stat-value" id="statActive">-</div>
    </div>
    <div class="stat-box ended">
      <div class="stat-label">Ended Posts</div>
      <div class="stat-value" id="statEnded">-</div>
    </div>
    <div class="stat-box archived">
      <div class="stat-label">Archived Posts</div>
      <div class="stat-value" id="statArchived">-</div>
    </div>
  </div>
</div>

<div class="card">
  <h2>üóÑÔ∏è Archive Old Posts (Soft Delete)</h2>
  <p>Mark ended posts as archived. They will be hidden from feed but data is preserved.</p>

  <div style="margin: 16px 0;">
    <button onclick="previewArchive(7)" class="secondary">Preview > 7 days</button>
    <button onclick="previewArchive(14)" class="secondary">Preview > 14 days</button>
    <button onclick="previewArchive(30)" class="secondary">Preview > 30 days</button>
  </div>

  <div style="margin: 16px 0;">
    Ended older than (days):
    <input id="archiveDaysInput" type="number" value="14" style="width: 80px" />
    <br /><br />
    <input id="confirmArchive" placeholder='Type "ARCHIVE"' />
    <button class="warning" onclick="archiveOldPosts()">Archive Posts</button>
  </div>
</div>

<div class="section-divider"></div>

<div class="card">
  <h2>‚ö†Ô∏è Hard Delete Archived Posts</h2>
  <p class="warn">Permanently deletes posts and related data. Cannot be undone.</p>

  <div style="margin: 16px 0;">
    Archived older than (days):
    <input id="deleteDaysInput" type="number" value="30" style="width: 80px" />
    <br /><br />
    <input id="confirmDelete" placeholder='Type "DELETE FOREVER"' />
    <button class="secondary" onclick="previewDelete()">Preview Delete</button>
    <button class="danger" onclick="hardDeleteArchived()">Hard Delete</button>
  </div>
</div>

<div class="section-divider"></div>

<div class="card">
  <h2>üë§ Delete User and All Posts</h2>
  <p>Deletes user profile, refs, user-posts, and all posts owned by this UID.</p>

  User UID:
  <input id="uidInput" style="min-width:300px" placeholder="Paste Firebase Auth UID" />

  <br /><br />
  <input id="confirmDeleteUser" placeholder='Type "DELETE USER"' />
  <button class="secondary" onclick="dryRunDeleteUser()">Dry-run</button>
  <button class="danger" onclick="deleteUser()">Execute delete</button>
</div>

<div class="card">
  <h2>üìù Logs</h2>
  <button onclick="clearLogs()" class="secondary">Clear Logs</button>
  <pre id="log"></pre>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    GithubAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    update,
    remove
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  /* ================= Firebase Config (WEB APP) ================= */
  const firebaseConfig = {
    apiKey: "AIzaSyBLWO8TizA5wWEeHl_-miGSE-DgqNvIuQA",
    authDomain: "ready5km.firebaseapp.com",
    databaseURL: "https://ready5km-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ready5km",
    storageBucket: "ready5km.firebasestorage.app",
    messagingSenderId: "148288973474",
    appId: "1:148288973474:web:e9ff9d7ab9498c976185fb",
    measurementId: "G-Y5CN9H0539"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const logEl = document.getElementById("log");
  const authStatus = document.getElementById("authStatus");

  function log(msg, obj) {
    const timestamp = new Date().toISOString();
    logEl.textContent += `[${timestamp}] ${msg}\n`;
    if (obj) logEl.textContent += JSON.stringify(obj, null, 2) + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  window.clearLogs = () => {
    logEl.textContent = "";
    log("Logs cleared");
  };

  /* ================= Auth ================= */
  window.loginWithGithub = async () => {
    try {
      const provider = new GithubAuthProvider();
      await signInWithPopup(auth, provider);
      log("‚úÖ Login success");
    } catch (e) {
      log("‚ùå Login failed", e);
    }
  };

  window.logout = async () => {
    await signOut(auth);
    log("‚úÖ Logged out");
  };

  onAuthStateChanged(auth, (user) => {
    authStatus.textContent = user
      ? `Signed in: ${user.uid}`
      : "Signed out";
  });

  /* ================= Helpers ================= */
  const nowSec = () => Math.floor(Date.now() / 1000);

  /* ================= Database Statistics ================= */
  window.loadStats = async () => {
    try {
      log("Loading database statistics...");
      const snap = await get(ref(db, "posts"));
      const now = nowSec();
      
      let total = 0;
      let active = 0;
      let ended = 0;
      let archived = 0;

      snap.forEach(child => {
        const post = child.val();
        total++;
        
        if (post.isArchived) {
          archived++;
        } else if (post.endedAt && post.endedAt < now) {
          ended++;
        } else {
          active++;
        }
      });

      document.getElementById("statTotal").textContent = total;
      document.getElementById("statActive").textContent = active;
      document.getElementById("statEnded").textContent = ended;
      document.getElementById("statArchived").textContent = archived;

      log(`‚úÖ Stats loaded: ${total} total, ${active} active, ${ended} ended, ${archived} archived`);
    } catch (e) {
      log("‚ùå Failed to load stats", e);
    }
  };

  /* ================= Archive old posts (Soft Delete) ================= */
  window.previewArchive = async (days) => {
    try {
      const cutoff = nowSec() - (days * 86400);
      const snap = await get(ref(db, "posts"));
      const candidates = [];

      snap.forEach(child => {
        const post = child.val();
        const postId = child.key;
        
        // Only archive if: ended AND not already archived
        if (post.endedAt && post.endedAt < cutoff && !post.isArchived) {
          candidates.push({
            id: postId,
            title: post.title,
            endedAt: post.endedAt,
            daysAgo: Math.floor((nowSec() - post.endedAt) / 86400)
          });
        }
      });

      candidates.sort((a, b) => a.endedAt - b.endedAt);

      log(`üìã Preview: ${candidates.length} posts ended > ${days} days ago`);
      if (candidates.length > 0) {
        log("Sample posts (oldest 10):", candidates.slice(0, 10));
      }
    } catch (e) {
      log("‚ùå Preview failed", e);
    }
  };

  window.archiveOldPosts = async () => {
    if (confirmArchive.value !== "ARCHIVE") {
      alert('Type "ARCHIVE" to confirm');
      return;
    }

    try {
      const days = Number(archiveDaysInput.value);
      const cutoff = nowSec() - (days * 86400);
      const now = nowSec();
      
      log(`üóÑÔ∏è Archiving posts ended > ${days} days ago...`);
      
      const snap = await get(ref(db, "posts"));
      let archived = 0;

      for (const child of snap.children) {
        const post = child.val();
        const postId = child.key;
        
        // Archive if: ended AND not already archived
        if (post.endedAt && post.endedAt < cutoff && !post.isArchived) {
          await update(ref(db, `posts/${postId}`), {
            isArchived: true,
            archivedAt: now
          });
          archived++;
        }
      }

      confirmArchive.value = "";
      log(`‚úÖ Archived ${archived} posts`);
      loadStats(); // Refresh stats
    } catch (e) {
      log("‚ùå Archive failed", e);
    }
  };

  /* ================= Hard Delete Archived Posts ================= */
  window.previewDelete = async () => {
    try {
      const days = Number(deleteDaysInput.value);
      const cutoff = nowSec() - (days * 86400);
      const snap = await get(ref(db, "posts"));
      const candidates = [];

      snap.forEach(child => {
        const post = child.val();
        const postId = child.key;
        
        // Only delete if: archived AND archivedAt older than cutoff
        if (post.isArchived && post.archivedAt && post.archivedAt < cutoff) {
          candidates.push({
            id: postId,
            title: post.title,
            archivedAt: post.archivedAt,
            daysAgo: Math.floor((nowSec() - post.archivedAt) / 86400)
          });
        }
      });

      candidates.sort((a, b) => a.archivedAt - b.archivedAt);

      log(`‚ö†Ô∏è Preview: ${candidates.length} archived posts > ${days} days old`);
      if (candidates.length > 0) {
        log("Will be permanently deleted:", candidates);
      }
    } catch (e) {
      log("‚ùå Preview failed", e);
    }
  };

  window.hardDeleteArchived = async () => {
    if (confirmDelete.value !== "DELETE FOREVER") {
      alert('Type "DELETE FOREVER" to confirm permanent deletion');
      return;
    }

    try {
      const days = Number(deleteDaysInput.value);
      const cutoff = nowSec() - (days * 86400);
      
      log(`‚ö†Ô∏è Hard deleting archived posts > ${days} days old...`);
      
      const snap = await get(ref(db, "posts"));
      let deleted = 0;

      for (const child of snap.children) {
        const post = child.val();
        const postId = child.key;
        
        // Delete if: archived AND archivedAt older than cutoff
        if (post.isArchived && post.archivedAt && post.archivedAt < cutoff) {
          await remove(ref(db, `posts/${postId}`));
          // TODO: Also delete from user-posts, comments, etc.
          deleted++;
        }
      }

      confirmDelete.value = "";
      log(`‚úÖ Permanently deleted ${deleted} archived posts`);
      loadStats(); // Refresh stats
    } catch (e) {
      log("‚ùå Hard delete failed", e);
    }
  };

  /* ================= Delete user ================= */
  window.dryRunDeleteUser = async () => {
    const uid = uidInput.value.trim();
    if (!uid) return alert("UID required");

    try {
      const snap = await get(ref(db, `user-posts/${uid}`));
      const count = snap.exists() ? Object.keys(snap.val()).length : 0;
      log(`üìã Dry-run: user ${uid} has ${count} posts`);
    } catch (e) {
      log("‚ùå Dry-run failed", e);
    }
  };

  window.deleteUser = async () => {
    if (confirmDeleteUser.value !== "DELETE USER") {
      alert('Type "DELETE USER" to confirm');
      return;
    }

    const uid = uidInput.value.trim();
    if (!uid) return alert("UID required");

    try {
      log(`‚ö†Ô∏è Deleting user ${uid}...`);
      
      await remove(ref(db, `users/${uid}`));
      await remove(ref(db, `user-posts/${uid}`));
      await remove(ref(db, `user-refs/${uid}`));

      confirmDeleteUser.value = "";
      log(`‚úÖ Deleted user ${uid} and related data`);
    } catch (e) {
      log("‚ùå Delete user failed", e);
    }
  };

  /* ================= Initialization ================= */
  log("‚úÖ Admin page loaded");
  log("üí° Start by clicking 'Refresh Stats' to see database status");
</script>

</body>
</html>
