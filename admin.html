<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>in5KM Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      margin: 32px;
      background: #fafafa;
    }
    h1 { margin-bottom: 4px; }
    h2 { margin-top: 32px; }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-top: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }
    button {
      padding: 8px 14px;
      margin-right: 8px;
      cursor: pointer;
    }
    button.danger {
      background: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button.secondary {
      background: #eee;
      border: none;
      border-radius: 4px;
    }
    input {
      padding: 6px;
      margin-right: 6px;
      min-width: 120px;
    }
    .warn {
      color: #b00;
      font-weight: 600;
    }
    pre {
      background: #0b1020;
      color: #e6edf3;
      padding: 12px;
      border-radius: 6px;
      max-height: 300px;
      overflow: auto;
      font-size: 13px;
    }
  </style>
</head>
<body>

<h1>in5KM Admin</h1>
<p class="warn">
  This page is public on GitHub Pages.  
  Security must be enforced via Firebase Auth + DB Rules (v2 will improve this).
</p>

<div class="card">
  <h2>Auth</h2>
  <button onclick="loginWithGithub()">Login with GitHub</button>
  <button onclick="logout()" class="secondary">Logout</button>
  <span id="authStatus">Signed out</span>
</div>

<div class="card">
  <h2>Cleanup old posts</h2>
  <p>Delete posts older than N days (and their copies under user-posts / query / query-visit).</p>

  Older than (days):
  <input id="daysInput" type="number" value="100" />

  <br /><br />
  <input id="confirmDeletePosts" placeholder='Type "DELETE"' />
  <button class="secondary" onclick="dryRunCleanup()">Dry-run</button>
  <button class="danger" onclick="cleanupOldPosts()">Execute delete</button>
</div>

<div class="card">
  <h2>Delete user and all posts</h2>
  <p>Deletes user profile, refs, user-posts, and all posts owned by this UID.</p>

  User UID:
  <input id="uidInput" style="min-width:300px" placeholder="Paste Firebase Auth UID" />

  <br /><br />
  <input id="confirmDeleteUser" placeholder='Type "DELETE USER"' />
  <button class="secondary" onclick="dryRunDeleteUser()">Dry-run</button>
  <button class="danger" onclick="deleteUser()">Execute delete</button>
</div>

<div class="card">
  <h2>Logs</h2>
  <pre id="log"></pre>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    GithubAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    remove
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  /* ================= Firebase Config (WEB APP) ================= */
  const firebaseConfig = {
    apiKey: "AIzaSyBLW0BTiZAsWwEHL_-miGSE-DgQNvUqA",
    authDomain: "ready5km.firebaseapp.com",
    databaseURL: "https://ready5km-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ready5km",
    storageBucket: "ready5km.appspot.com",
    messagingSenderId: "148288973474",
    appId: "1:148288973474:web:9ff9d7ab9498c976185fb"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const logEl = document.getElementById("log");
  const authStatus = document.getElementById("authStatus");

  function log(msg, obj) {
    logEl.textContent += `[${new Date().toISOString()}] ${msg}\n`;
    if (obj) logEl.textContent += JSON.stringify(obj, null, 2) + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  /* ================= Auth ================= */
  window.loginWithGithub = async () => {
    try {
      const provider = new GithubAuthProvider();
      await signInWithPopup(auth, provider);
      log("Login success");
    } catch (e) {
      log("Login failed", e);
    }
  };

  window.logout = async () => {
    await signOut(auth);
    log("Logged out");
  };

  onAuthStateChanged(auth, (user) => {
    authStatus.textContent = user
      ? `Signed in: ${user.uid}`
      : "Signed out";
  });

  /* ================= Helpers ================= */
  const nowSec = () => Math.floor(Date.now() / 1000);

  /* ================= Cleanup old posts ================= */
  window.dryRunCleanup = async () => {
    const days = Number(daysInput.value);
    const cutoff = nowSec() - days * 86400;

    const snap = await get(ref(db, "posts"));
    let count = 0;

    snap.forEach(c => {
      if (c.val().start < cutoff) count++;
    });

    log(`Dry-run: ${count} posts older than ${days} days`);
  };

  window.cleanupOldPosts = async () => {
    if (confirmDeletePosts.value !== "DELETE") {
      alert('Type "DELETE" to confirm');
      return;
    }

    const days = Number(daysInput.value);
    const cutoff = nowSec() - days * 86400;

    const snap = await get(ref(db, "posts"));
    let deleted = 0;

    for (const child of Object.entries(snap.val() || {})) {
      const [postId, post] = child;
      if (post.start < cutoff) {
        await remove(ref(db, `posts/${postId}`));
        deleted++;
      }
    }

    log(`Deleted ${deleted} old posts`);
  };

  /* ================= Delete user ================= */
  window.dryRunDeleteUser = async () => {
    const uid = uidInput.value.trim();
    if (!uid) return alert("UID required");

    const snap = await get(ref(db, "user-posts"));
    let count = 0;

    snap.forEach(u => {
      if (u.key === uid) count += u.size;
    });

    log(`Dry-run: user ${uid} has ${count} posts`);
  };

  window.deleteUser = async () => {
    if (confirmDeleteUser.value !== "DELETE USER") {
      alert('Type "DELETE USER" to confirm');
      return;
    }

    const uid = uidInput.value.trim();
    if (!uid) return alert("UID required");

    await remove(ref(db, `users/${uid}`));
    await remove(ref(db, `user-posts/${uid}`));
    await remove(ref(db, `user-refs/${uid}`));

    log(`Deleted user ${uid} and related data`);
  };

  log("Admin page loaded");
</script>

</body>
</html>
